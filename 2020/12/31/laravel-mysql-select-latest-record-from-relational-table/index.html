<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Laravel MySQL select latest record from relational table. | Ahmed Waleed</title>
    <meta name="generator" content="VuePress 1.6.0">
    
    <meta name="description" content="In this blog post we’re going to look how we can query latest record from relational table in MySql. I was working on client project and i needed to export persons latest attachment to some cloud CRM ...">
    <link rel="preload" href="/assets/css/0.styles.f20e20f9.css" as="style"><link rel="preload" href="/assets/js/app.5a34f3f5.js" as="script"><link rel="preload" href="/assets/js/6.743e9d74.js" as="script"><link rel="preload" href="/assets/js/3.c32d983c.js" as="script"><link rel="preload" href="/assets/js/15.6144428c.js" as="script"><link rel="prefetch" href="/assets/js/10.69f07e0e.js"><link rel="prefetch" href="/assets/js/11.53f87820.js"><link rel="prefetch" href="/assets/js/12.7f4e875a.js"><link rel="prefetch" href="/assets/js/13.07629488.js"><link rel="prefetch" href="/assets/js/14.9227bdd2.js"><link rel="prefetch" href="/assets/js/16.817d4768.js"><link rel="prefetch" href="/assets/js/17.7fb27a9d.js"><link rel="prefetch" href="/assets/js/18.474a133a.js"><link rel="prefetch" href="/assets/js/4.00b7630e.js"><link rel="prefetch" href="/assets/js/5.631f1efc.js"><link rel="prefetch" href="/assets/js/7.a54a7d27.js"><link rel="prefetch" href="/assets/js/8.bde22fe0.js"><link rel="prefetch" href="/assets/js/9.ce3d6c06.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.c82c253b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f20e20f9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">Ahmed Waleed </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tags</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">Ahmed Waleed </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tags</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        Laravel MySQL select latest record from relational table.
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">Ahmed Waleed</span> <span itemprop="address">   in Multan, Pakistan</span></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2020-12-31T00:00:00.000Z">
      Thu Dec 31 2020
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/tag/laravel" data-v-42ccfcd5><span data-v-42ccfcd5>laravel</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/php" data-v-42ccfcd5><span data-v-42ccfcd5>php</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/mysql" data-v-42ccfcd5><span data-v-42ccfcd5>mysql</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/query-builder" data-v-42ccfcd5><span data-v-42ccfcd5>query-builder</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><p>In this blog post we’re going to look how we can query latest record from relational table in MySql. I was working on client project and i needed to export persons latest attachment to some cloud CRM solution from our old legacy php mysql web application.</p> <p>Lets say we have two tables persons and attachments, i want to query first latest attachment for each person in mysql has many relationship, so i ended up with this query.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">`</span>p<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> 
       <span class="token punctuation">`</span>a<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token operator">*</span> 
<span class="token keyword">FROM</span>   <span class="token punctuation">`</span>persons<span class="token punctuation">`</span> <span class="token keyword">AS</span> <span class="token punctuation">`</span>p<span class="token punctuation">`</span> 
       <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> <span class="token punctuation">`</span>attachments<span class="token punctuation">`</span> <span class="token keyword">AS</span> <span class="token punctuation">`</span>a<span class="token punctuation">`</span> 
               <span class="token keyword">ON</span> <span class="token punctuation">`</span>a<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>person_id<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token punctuation">`</span>p<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span> 
       <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token punctuation">`</span>person_id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token function">Max</span><span class="token punctuation">(</span>created<span class="token punctuation">)</span> <span class="token keyword">AS</span> latest_date 
                   <span class="token keyword">FROM</span>   <span class="token punctuation">`</span>attachments<span class="token punctuation">`</span> 
                   <span class="token keyword">GROUP</span>  <span class="token keyword">BY</span> <span class="token punctuation">`</span>person_id<span class="token punctuation">`</span>
       <span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">`</span>latest_attachment<span class="token punctuation">`</span> 
       <span class="token keyword">ON</span> <span class="token punctuation">`</span>a<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>person_id<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token punctuation">`</span>latest_attachment<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>person_id<span class="token punctuation">`</span> 
       <span class="token operator">AND</span> <span class="token punctuation">`</span>a<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>created<span class="token punctuation">`</span> <span class="token operator">=</span>   <span class="token punctuation">`</span>latest_attachment<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>latest_date<span class="token punctuation">`</span>
</code></pre></div><p>If you take a closer look at query its simple to follow the only trick here is subquery in second inner join clause so basically what i am doing here is creating a <a href="https://stackoverflow.com/questions/12794127/mysql-select-data-and-create-a-virtual-table/12794206" target="_blank" rel="noopener noreferrer">virtual table<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> (latest_attachment) which represents only latest attachment for each person and then applying join based on person id and latest attachment created date.</p> <p>We have our raw query in place lets convert this to laravel <a href="https://laravel.com/docs/8.x/queries" target="_blank" rel="noopener noreferrer">query builder<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. Laravel allows us to pass subquery (virtual table) as first argument to <a href="https://laravel.com/docs/8.x/queries#joins" target="_blank" rel="noopener noreferrer">join<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> method but in the later versions after 5.6 laravel query builder has dedicated method <a href="https://laravel.com/docs/8.x/queries#subquery-joins" target="_blank" rel="noopener noreferrer">joinSub<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> which accepts first argument as closure with passing new query builder instance so that instead of passing raw subquery we can actually pass an query builder instance wraped with closure function and if we have more then one join condition we can pass those in second argument as closure, behind the scene laravel will call execute that closure and pass join instance in it so we can use it in our closure.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'persons'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'p'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'p.*'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'a.*'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'attachments as a'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'a.person_id'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'p.id'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">joinSub</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>Builder <span class="token variable">$query</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$query</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">select</span><span class="token punctuation">(</span>
                <span class="token single-quoted-string string">'person_id'</span><span class="token punctuation">,</span> 
                 <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'MAX(created) as latest_date'</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
            <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'avr_attachments'</span><span class="token punctuation">)</span>
            <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'person_id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'latest_attachment'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>JoinClause <span class="token variable">$join</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$join</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'a.person_id'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'='</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'latest_attachment.person_id'</span><span class="token punctuation">)</span>
            <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'a.created'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'='</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'latest_attachment.latest_date'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>This is how query looks like in laravel and we have successfully converted a raw mysql query to laravel query builder instance.</p> <hr> <p>Hopefully you have learned something in this post if you like it then please follow me on <a href="https://twitter.com/Ahmedwaleed11" target="_blank" rel="noopener noreferrer">Twitter<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. for more posts Thanks.</p></div> <footer><!----> <hr> <!----></footer></article> <!----></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8><li class="contact-item" data-v-3d9deeb8><a href="https://github.com/AhmadWaleed" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-3d9deeb8><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-3d9deeb8></path></svg>
          
        </a></li><li class="contact-item" data-v-3d9deeb8><a href="mailto:ahmedwaleed11599@gmail.com" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail" data-v-3d9deeb8><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" data-v-3d9deeb8></path><polyline points="22,6 12,13 2,6" data-v-3d9deeb8></polyline></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8><li class="copyright-item" data-v-3d9deeb8>Ahmed Waleed © 2022</li></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5a34f3f5.js" defer></script><script src="/assets/js/6.743e9d74.js" defer></script><script src="/assets/js/3.c32d983c.js" defer></script><script src="/assets/js/15.6144428c.js" defer></script>
  </body>
</html>
